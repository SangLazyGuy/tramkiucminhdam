<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>Flipbook</title>

  <audio id="bgMusic" loop>
    <source src="nhacnen.mp3" type="audio/mpeg">
  </audio>
</head>

<body>

  <div class="flipbook">
    <div class="hard">My Pokemon Gallery <small>~ HankTheTank</small></div>
    <div class="hard"></div>

    <!-- TRANG VIDEO -->
    <div class="page video-placeholder" data-video="video1"></div>

    <!-- IMAGE PAGES -->
    <div><img src="a.jpg" /></div>
    <div><img src="a.jpg" /></div>
    <div><img src="b.jpg" /></div>
    <div><img src="c.jpg" /></div>
    <div><img src="d.jpg" /></div>

    <div class="hard"></div>
    <div class="hard">Thank You <small>~ HankTheTank</small></div>
  </div>

  <!-- VIDEO OVERLAY -->
  <div id="video-container">
    <video id="video1" class="video-ui" src="video1.mp4"></video>
    <input type="range" id="seek1" class="seekbar" value="0" min="0" max="100">
  </div>

  <!-- LIBRARIES -->
  <script src="jquery.js"></script>
  <script src="turn.js"></script>

  <!-- INIT BOOK -->
  <script>
    $(".flipbook").turn();
  </script>

  <!-- AUDIO MEMORY -->
  <script>
    const audio = document.getElementById("bgMusic");

    function restoreAudioTime() {
      const saved = localStorage.getItem("bgMusicTime");
      if (saved) audio.currentTime = parseFloat(saved);
    }

    audio.addEventListener("loadedmetadata", restoreAudioTime);

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) {
        restoreAudioTime();
        audio.play().catch(() => {});
      }
    });

    audio.play().catch(() => {});
    function saveAudio() { localStorage.setItem("bgMusicTime", audio.currentTime); }

    window.addEventListener("beforeunload", saveAudio);
    window.addEventListener("pagehide", saveAudio);

    setInterval(saveAudio, 2000);
  </script>

  <!-- VIDEO LOGIC HOÀN CHỈNH -->
  <script>
    $(".flipbook").turn({
      when: {
        turned: function (e, page) {

          const VC = document.getElementById("video-container");
          VC.classList.remove("active");

          const pageEl = $(".flipbook").children().eq(page - 1);
          const videoId = pageEl.data("video");

          if (!videoId) return;

          const rect = pageEl[0].getBoundingClientRect();
          VC.style.left = rect.left + "px";
          VC.style.top = rect.top + "px";
          VC.style.width = rect.width + "px";
          VC.style.height = rect.height + "px";

          VC.classList.add("active");

          const video = document.getElementById(videoId);
          const seek = document.getElementById("seek1");

          video.pause();
          video.currentTime = 0;

          video.muted = true;     /* đảm bảo autoplay không bị chặn */
          video.play().catch(() => {});

          const precision = 10;

          if (video.readyState >= 1) {
            seek.max = Math.floor(video.duration * precision);
          } else {
            video.onloadedmetadata = () => {
              seek.max = Math.floor(video.duration * precision);
            };
          }

          seek.oninput = () => {
            video.currentTime = seek.value / precision;
          };

          function updateSeek() {
            seek.value = Math.floor(video.currentTime * precision);
            requestAnimationFrame(updateSeek);
          }
          updateSeek();
        }
      }
    });
  </script>

</body>
</html>
